# 对象创建与类加载机制

当Java虚拟机遇到一条字节码为new的指令时，**首先去检查这个指令的参数是否能在常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已经被加载，解析和初始化过，如果没有，那必须先执行相应的加载过程。**

### **类加载时机**

![类生命周期](<../.gitbook/assets/image (13).png>)

一：遇到new，getstatic，putstatic或invokestatic这四条字节码指令时，如果类型没有进行初始化，则需要触发初始化阶段：

1）new关键字实例化对象的时候。

2）读取或设置一个类型的静态字段。

3）调用一个类型的静态方法的时候。

二：使用java.lang.reflect包的方法对类型进行反射调用的时候，如果类型没有进行过初始化，则需要先触发其初始化。

三：当初始化类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化。

四：当虚拟机启动时，用户需要指定一个要执行的主类（包含main()方法的那个类），虚拟机会先初始化这个主类。

五：当使用JDK 7新加入的动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果为REF\_getStatic、REF\_putStatic、REF\_invokeStatic、REF\_newInvokeSpecial四种类型的方法句柄，并且这个方法句柄对应的类没有进行过初始化，则需要先触发其初始化。

六：当一个接口中定义了JDK 8新加入的默认方法（被default关键字修饰的接口方法）时，如果有这个接口的实现类发生了初始化，那该接口要在其之前被初始化。

#### 加载

此阶段完成三件事情：

1）通过一个类的全限定命名来获取定义此类的二进制字节流。

2）将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。

3）在内存中生产一个代表这个类的java.lang.class对象，作为方法区的访问入口。

**总的来说就是把java文件读入Jvm所定义的内存结构中。**

#### 验证

验证Class文件的字节流也就是第一步加载的字节流是否符合《Java虚拟机规范》的全部约束，确保这些代码运行后不会威胁虚拟机自身安全。

同时验证可以分为四个阶段：文件格式验证，元数据验证，字节码验证，符号引用验证。

1）文件格式验证主要检查class文件的结构是否符合当前版本虚拟机的规范，比如魔数，版本号，常亮池等，后面的三种验证都是基于第一步所读取的流在做。

2）第二阶段的主要目的是对类的元数据信息进行语义校验，保证不存在与《Java语言规范》定义相悖的元数据信息。

3）第三阶段是整个验证过程中最复杂的一个阶段，主要目的是通过数据流分析和控制流分析，确定程序语义是合法的、符合逻辑的。在第二阶段对元数据信息中的数据类型校验完毕以后，这阶段就要对类的方法体（Class文件中的Code属性）进行校验分析，保证被校验类的方法在运行时不会做出危害虚拟机安全的行为。

4）符号引用中通过字符串描述的全限定名是否能找到对应的类。

&#x20;     在指定类中是否存在符合方法的字段描述符及简单名称所描述的方法和字段。

&#x20;      符号引用中的类、字段、方法的可访问性（private、protected、public、）是否可被当前类访问。

**符号引用验证的主要目的是确保解析行为能正常执行**，如果无法通过符号引用验证，Java虚拟机将会抛出一个java.lang.IncompatibleClassChangeError的子类异常，典型的如：java.lang.IllegalAccessError、java.lang.NoSuchFieldError、java.lang.NoSuchMethodError等。

**验证阶段对于虚拟机的类加载机制来说，是一个非常重要的、但却不是必须要执行的阶段，因为验证阶段只有通过或者不通过的差别，只要通过了验证，其后就对程序运行期没有任何影响了。**如果程序运行的全部代码（包括自己编写的、第三方包中的、从外部加载的、动态生成的等所有代码）都已经被反复使用和验证过，在**生产环境的实施阶段就可以考虑使用-Xverify：none参数来关闭大部分的类验证措施，以缩短虚拟机类加载的时间。**

#### 准备

正式为类中定义的变量（static修饰的，也称之为静态变量）分配内存并设置初始值（这里的初始值实际上指的是默认值，比如int的默认值为0，以此类推**，**具体的value要执行到类的初始化阶段才会有）。

**注意：此阶段进行内存分配的仅仅是类变量，不包括其他实例变量，实例变量会随着对象一起被放入Java堆中。**

**例外：如果此变量被声明为constant，也就是下面这种格式，那么在准备阶段就会固定初实值。**

```java
public static final int value = 123
```

#### **解析**

通俗来讲就是解析字节码的流程，在此阶段，JVM将常量池内得到符号引用替换为直接引用的过程。

分为常量解析，类或接口解析，字段解析，方法解析。

#### 初始化

类的初始化阶段是类加载过程的最后一个步骤，之前介绍的几个类加载的动作里，除了在加载阶段用户应用程序可以**通过自定义类加载器的方式局部参与外，其余动作都完全由Java虚拟机来主导控制**。

直到初始化阶段，Java虚拟机才真正开始执行类中编写的Java程序代码，将主导权移交给应用程序。

